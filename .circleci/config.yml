version: 2.1

orbs:
  git: opuscapita/git@volatile
  jira: circleci/jira@1.2.2

aliases:
  - &save-cache-checksum
    name: Save cache checksum
    command: |
      find . -name "package.json" | sort | xargs cat >> /tmp/cache-checksum
      find . -name "pom.xml" | sort | xargs cat >> /tmp/cache-checksum

  - &restore-cache
    keys:
      - dependencies-{{ checksum "/tmp/cache-checksum" }}
      - dependencies

  - &save-cache
    key: dependencies-{{ checksum "/tmp/cache-checksum" }}
    paths:
      - ./package-lock.json
      - ./node_modules
      - ./packages/client-react/package-lock.json
      - ./packages/client-react/node_modules
      - ./packages/connector-google-drive-v2/package-lock.json
      - ./packages/connector-google-drive-v2/node_modules
      - ./packages/connector-node-v1/package-lock.json
      - ./packages/connector-node-v1/node_modules
      - ./packages/server-nodejs/package-lock.json
      - ./packages/server-nodejs/node_modules
      - ./packages/demoapp/package-lock.json
      - ./packages/demoapp/node_modules
      - ~/.m2/repository

executors:
  code:
    docker:
      - image: opuscapita/minsk-core-ci:5
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
  deployment:
    docker:
      - image: opuscapita/minsk-core-ci:deploy
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS

jobs:
  init:
    docker:
      - image: opuscapita/minsk-core-machineuser-env:2
    steps:
      - run: circle_ci_add_env.sh

  build:
    executor: code
    steps:
      - setup_remote_docker
      - git/checkout-with-submodules
      - run: *save-cache-checksum
      - restore_cache: *restore-cache
      - run: make js-install-deps js-lint js-test
      - store_test_results:
          path: ./packages/server-nodejs/test-results
      - store_artifacts:
          path: ./packages/server-nodejs/test-results
      - run: if [ ! -z "${CIRCLE_TAG}" ]; then make js-publish; else echo "This step is skipped as this is not a release build"; fi
      - run: if [ -z "${CIRCLE_TAG}" ]; then make js-build; fi
      - run: make java-build
      - save_cache: *save-cache
      - run: if [ -z "${CIRCLE_TAG}" ]; then make build-docker; fi
      - run: if [ -z "${CIRCLE_TAG}" ]; then make publish-docker; fi

  deploy:
    executor: deployment
    steps:
      - git/checkout-with-submodules
      - run: make deploy-demo

workflows:
  version: 2
  commit:
    jobs:
      - init:
          filters:
            tags:
              only: /.*/
      - build:
          requires:
            - init
          filters:
            tags:
              only: /.*/
          post-steps:
            - jira/notify
      - deploy:
          requires:
            - init
            - build
          filters:
            tags:
              ignore: /.+/
